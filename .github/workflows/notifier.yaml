name: üîî Discord Notification on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  notify:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Files Diff (Cr√©√©s et Modifi√©s dans docs/**/*.md)
        id: diff
        uses: dorny/paths-filter@v3
        with:
          filters: |
            added: 
              - added: "**/*.md"
            modified: 
              - modified: "**/*.md"

      - name: Prepare Discord Payload
        id: payload
        run: |
          ADDED_FILES="${{ steps.diff.outputs.added_files }}"
          MODIFIED_FILES="${{ steps.diff.outputs.modified_files }}"

          if [ -z "$ADDED_FILES" ] && [ -z "$MODIFIED_FILES" ]; then
            echo "::notice file=notify-discord-on-merge.yml::Aucun fichier docs/**/*.md cr√©√© ou modifi√©, la notification sera ignor√©e."
            exit 0 
          fi
          
          if [ -z "$ADDED_FILES" ]; then
            ADDED_LIST="> *Aucun nouveau fichier de documentation cr√©√©.*"
          else
            ADDED_LIST=$(echo "$ADDED_FILES" | sed 's/ /\n> ‚ûï /g' | sed 's/^/> ‚ûï /')
          fi

          if [ -z "$MODIFIED_FILES" ]; then
            MODIFIED_LIST="> *Aucun fichier de documentation modifi√©.*"
          else
            # Remplace les espaces par des sauts de ligne + ajouter un pr√©fixe ‚úçÔ∏è
            MODIFIED_LIST=$(echo "$MODIFIED_FILES" | sed 's/ /\n> ‚úçÔ∏è /g' | sed 's/^/> ‚úçÔ∏è /')
          fi

          DISCORD_MESSAGE="**üéâ Nouvelles contributions (${{ github.event.pull_request.number }})**"
          DISCORD_MESSAGE+="\n\n**Titre :** ${{ github.event.pull_request.title }}"
          DISCORD_MESSAGE+="\n**Auteur :** ${{ github.event.pull_request.user.login }}"
          DISCORD_MESSAGE+="\n\n---"
          DISCORD_MESSAGE+="\n\n**Nouvelles docs:**\n$ADDED_LIST"
          DISCORD_MESSAGE+="\n\n**Docs Modifi√©se:**\n$MODIFIED_LIST"
          DISCORD_MESSAGE+="\n\n[Voir la PR](${{ github.event.pull_request.html_url }})"

          echo "DISCORD_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$DISCORD_MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Discord Notification
        if: success() && env.DISCORD_MESSAGE != ''
        uses: Ilshidur/action-discord@master
        env: 
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ env.DISCORD_MESSAGE }}